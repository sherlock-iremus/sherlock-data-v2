name: feed-search-engine
# Controls when the workflow will run
on:
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  get-resources-uris:
    runs-on: ubuntu-latest
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '20.x'

      - name: download js sparql query
        run: wget https://raw.githubusercontent.com/sherlock-iremus/sherlock-sparql-queries/main/src/queries/getResources.js

      - name: Use js sparql query
        run: |
          node -e '
          const https = require("https");
          const fs = require("fs");
          const sparqlQuery = require("./getResources.js");
          const options = {
            hostname: "data-iremus.huma-num.fr",
            path: "/sparql",
            method: "POST",
            headers: {
              "Content-Type": "application/x-www-form-urlencoded",
              "Accept": "application/json",
            },
          };
          const req = https.request(options, (res) => {
            let data = [];
          
            res.on("data", (chunk) => {
              data.push(chunk);
            });
          
            res.on("end", () => {
              fs.writeFileSync("res.json",JSON.stringify(JSON.parse(Buffer.concat(data).toString())))
            });
          });
          
          req.on("error", (e) => {
            console.error(e);
          });
          
          req.write(`query=${encodeURIComponent(sparqlQuery())}`);
          req.end();
          '

      - name: execute command on prod
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          password: ${{ secrets.SSH_PWD }}
          port: 22
          script: |
            whoami
            ls -al

      - name: cache resource uris on prod
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: 22
          source: "./res.json"
          target: elastic-search
          
